# Implementation Plan: Codebase Refactoring

## Overview

This implementation plan breaks down the codebase refactoring into incremental tasks. Each task builds on previous work and focuses on one aspect of the refactoring. The approach prioritizes extracting logic into testable modules first, then refactoring components to use those modules.

## Tasks

- [x] 1. Set up shared utilities and types
  - [x] 1.1 Create Result type for error handling
    - Create `src/shared/result.ts` with Result type and helper functions
    - Export ok, err, map, flatMap utilities
    - _Requirements: 8.1_
  - [x] 1.2 Reorganize Terminal UI types into domain-specific files
    - Create `src/ui/types/messages.ts` for message-related types
    - Create `src/ui/types/sessions.ts` for session-related types
    - Create `src/ui/types/tools.ts` for tool-related types
    - Create `src/ui/types/ui-state.ts` for UI state types
    - Create `src/ui/types/index.ts` to re-export all types
    - Add JSDoc comments to complex types
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 1.3 Write unit tests for Result type
    - Test ok, err, map, flatMap functions
    - _Requirements: 8.1_

- [x] 2. Extract utility functions
  - [x] 2.1 Create text-utils module
    - Create `src/ui/utils/text-utils.ts`
    - Move wrapText, wrapAnsiText, stripAnsi functions
    - Move truncate function
    - Add JSDoc documentation
    - _Requirements: 7.1, 7.4_
  - [x] 2.2 Create format-utils module
    - Create `src/ui/utils/format-utils.ts`
    - Move formatTokens, formatTime functions
    - Move generateId function
    - Add JSDoc documentation
    - _Requirements: 7.2, 7.4_
  - [x] 2.3 Create utils index file
    - Create `src/ui/utils/index.ts` to re-export all utilities
    - Update imports in existing files
    - _Requirements: 7.1, 7.2_
  - [x] 2.4 Write property test for utility function purity
    - **Property 4: Utility Function Purity**
    - Test that same inputs produce same outputs
    - **Validates: Requirements 7.3**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Create service modules
  - [x] 4.1 Create tool-formatters service
    - Create `src/ui/services/tool-formatters.ts`
    - Extract formatToolInputSummary function from ChatFeed
    - Extract formatToolOutput function from ChatFeed
    - Extract TOOL_DISPLAY configuration
    - Create ToolFormatter interface
    - _Requirements: 4.1, 3.5_
  - [x] 4.2 Write property test for tool formatter purity
    - **Property 2: Tool Formatter Purity**
    - Test that same tool/args produce same output
    - **Validates: Requirements 7.3**
  - [x] 4.3 Create command-handler service
    - Create `src/ui/services/command-handler.ts`
    - Extract parseCommand function
    - Extract command execution logic from App.tsx
    - Create CommandHandler interface
    - Return Result types for error cases
    - _Requirements: 4.3, 8.1_
  - [x] 4.4 Write property test for service Result types
    - **Property 3: Service Result Types**
    - Test that services return Result types on errors
    - **Validates: Requirements 8.1**
  - [x] 4.5 Create session-service module
    - Create `src/ui/services/session-service.ts`
    - Extract session creation logic
    - Extract session serialization/deserialization
    - _Requirements: 4.2_
  - [x] 4.6 Create services index file
    - Create `src/ui/services/index.ts` to re-export all services
    - _Requirements: 4.1, 4.2, 4.3_

- [x] 5. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. Create custom hooks
  - [x] 6.1 Create useInput hook
    - Create `src/ui/hooks/useInput.ts`
    - Extract input state (value, cursorIndex)
    - Extract input manipulation functions
    - Extract command history logic
    - _Requirements: 1.2_
  - [x] 6.2 Create useModal hook
    - Create `src/ui/hooks/useModal.ts`
    - Extract modal state (activeModal, selectionIndex)
    - Extract modal navigation functions
    - _Requirements: 1.3_
  - [x] 6.3 Create useSession hook
    - Create `src/ui/hooks/useSession.ts`
    - Extract session state management
    - Extract message management functions
    - Use session-service internally
    - _Requirements: 1.1_
  - [x] 6.4 Create useAgentConfig hook
    - Create `src/ui/hooks/useAgentConfig.ts`
    - Extract provider, model, mode, thinking state
    - Extract configuration update functions
    - _Requirements: 1.4_
  - [x] 6.5 Update hooks index file
    - Update `src/ui/hooks/index.ts` to export all hooks
    - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 7. Extract keyboard handler
  - [x] 7.1 Create keyboard handler module
    - Create `src/ui/services/keyboard-handler.ts`
    - Extract key routing logic from App.tsx useInput
    - Create KeyboardHandler interface
    - Make module independent of React
    - _Requirements: 2.1, 2.4_
  - [x] 7.2 Write property test for keyboard routing
    - **Property 1: Keyboard Input Routing**
    - Test that keys route to correct handlers based on context
    - **Validates: Requirements 2.2, 2.3**

- [x] 8. Checkpoint - Ensure all tests pass
  - All 99 tests pass (5 test files)

- [x] 9. Split modal components
  - [x] 9.1 Create modals directory structure
    - Create `src/ui/components/modals/` directory
    - Move ModalContainer to `src/ui/components/modals/ModalContainer.tsx`
    - _Requirements: 3.3_
  - [x] 9.2 Split HelpModal into separate file
    - Create `src/ui/components/modals/HelpModal.tsx`
    - _Requirements: 3.3_
  - [x] 9.3 Split ThemeModal into separate file
    - Create `src/ui/components/modals/ThemeModal.tsx`
    - _Requirements: 3.3_
  - [x] 9.4 Split ModelsModal into separate file
    - Create `src/ui/components/modals/ModelsModal.tsx`
    - _Requirements: 3.3_
  - [x] 9.5 Split SessionsModal into separate file
    - Create `src/ui/components/modals/SessionsModal.tsx`
    - _Requirements: 3.3_
  - [x] 9.6 Split remaining modals into separate files
    - Create ProviderModal.tsx, SettingsModal.tsx, ApiKeyModal.tsx
    - Create ThinkingModal.tsx, CopilotAuthModal.tsx
    - _Requirements: 3.3_
  - [x] 9.7 Create modals index file
    - Create `src/ui/components/modals/index.ts`
    - Update imports in components/index.ts
    - _Requirements: 3.3_

- [x] 10. Split chat components
  - [x] 10.1 Create chat directory structure
    - Create `src/ui/components/chat/` directory
    - _Requirements: 3.1, 3.2_
  - [x] 10.2 Create ToolDisplay component
    - Create `src/ui/components/chat/ToolDisplay.tsx`
    - Extract tool rendering logic from ChatFeed
    - Use tool-formatters service
    - _Requirements: 3.1, 3.5_
  - [x] 10.3 Create ToolGroup component
    - Create `src/ui/components/chat/ToolGroup.tsx`
    - Extract tool grouping logic
    - _Requirements: 3.1_
  - [x] 10.4 Create ToolOutput component
    - Created tool-utils.ts with formatToolOutput
    - Extract tool output rendering
    - _Requirements: 3.1_
  - [x] 10.5 Create MessageRenderer component
    - Create `src/ui/components/chat/MessageRenderer.tsx`
    - Extract message rendering logic from ChatFeed
    - _Requirements: 3.2_
  - [x] 10.6 Refactor ChatFeed to use new components
    - Update ChatFeed to delegate to ToolDisplay and MessageRenderer
    - ChatFeed reduced from ~550 lines to ~80 lines
    - _Requirements: 3.1, 3.2, 3.4_
  - [x] 10.7 Create tools and chat index files
    - Create `src/ui/components/chat/index.ts`
    - _Requirements: 3.1, 3.2_

- [x] 11. Checkpoint - Ensure all tests pass
  - All 99 tests pass, build succeeds

- [x] 12. Split input components
  - [x] 12.1 Create input directory structure
    - Create `src/ui/components/input/` directory
    - _Requirements: 3.3_
  - [x] 12.2 Extract Autocomplete component
    - Create `src/ui/components/input/Autocomplete.tsx`
    - Extract autocomplete dropdown from InputBox
    - _Requirements: 3.3_
  - [x] 12.3 Refactor InputBox to use Autocomplete
    - Update InputBox to use extracted Autocomplete component
    - Also extracted ModeSelector component
    - _Requirements: 3.3_

- [x] 13. Refactor App.tsx to use hooks and services
  - [x] 13.1 Create useAgentStream hook
    - Created `src/ui/hooks/useAgentStream.ts`
    - Extracts agent streaming, message submission, tool execution
    - Handles auto-compaction, token tracking, bash approval
    - _Requirements: 1.2, 4.3_
  - [x] 13.2 Integrate useInput hook into App
    - Replaced inline input state with useInputState hook
    - _Requirements: 1.2_
  - [x] 13.3 Integrate useModal hook into App
    - Replaced inline modal state with useModalState hook
    - _Requirements: 1.3_
  - [x] 13.4 Integrate useSession hook into App
    - Replaced inline session state with useSessionState hook
    - _Requirements: 1.1_
  - [x] 13.5 Integrate useAgentConfig hook into App
    - Replaced inline agent config state with useAgentConfig hook
    - _Requirements: 1.4_
  - [x] 13.6 Integrate keyboard handler into App
    - Replaced inline useInput handler with keyboard handler service
    - Uses handleKeyboardInput from services/keyboard-handler.ts
    - _Requirements: 2.1_
  - [x] 13.7 Integrate command handler into App
    - Uses parseCommand, getCompletions, getCommand from services/command-handler.ts
    - _Requirements: 4.3_
  - [x] 13.8 Final App.tsx cleanup
    - App.tsx reduced from 2409 lines to 712 lines (70% reduction)
    - All hooks and services integrated
    - _Requirements: 1.5_
    - **Note**: 712 lines is larger than 200 target due to complex command handling and modal logic that requires UI state access

- [x] 14. Checkpoint - Ensure all tests pass
  - All 99 tests pass (5 test files)
  - Build succeeds

- [ ] 15. Refactor Web UI
  - [ ] 15.1 Create ChatPanel component
    - Create `src/web-ui/components/panels/ChatPanel.tsx`
    - Extract chat panel JSX from App.tsx
    - _Requirements: 5.3, 5.4_
  - [ ] 15.2 Create EditorPanel component
    - Create `src/web-ui/components/panels/EditorPanel.tsx`
    - Extract editor panel JSX from App.tsx
    - _Requirements: 5.3_
  - [ ] 15.3 Create FileTreePanel component
    - Create `src/web-ui/components/panels/FileTreePanel.tsx`
    - Extract file tree panel JSX from App.tsx
    - _Requirements: 5.3_
  - [ ] 15.4 Create useChat hook
    - Create `src/web-ui/hooks/useChat.ts`
    - Extract chat state and SSE handling from App.tsx
    - _Requirements: 5.2_
  - [ ] 15.5 Create useFileSystem hook
    - Create `src/web-ui/hooks/useFileSystem.ts`
    - Extract file/editor state from App.tsx
    - _Requirements: 5.2_
  - [ ] 15.6 Refactor Web UI App.tsx
    - Update App.tsx to use new panel components and hooks
    - Ensure App.tsx is focused on composition
    - _Requirements: 5.3_
  - [ ] 15.7 Update Web UI hooks index
    - Update `src/web-ui/hooks/index.ts` to export all hooks
    - _Requirements: 5.2_

- [x] 16. Update component exports
  - [x] 16.1 Update Terminal UI component index
    - Update `src/ui/components/index.ts` with new component structure
    - Added exports for chat/, input/, and modals/ components
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 16.2 Verify all imports are updated
    - Check all files import from correct locations
    - Remove any dead code
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 16.5 UI Improvements (User Request)
  - [x] 16.5.1 Remove right sidebar
    - Removed ContextSidebar from App.tsx layout
    - Updated mainWidth to use full terminal width
    - Removed SIDEBAR_WIDTH import
    - _Result: Full-width chat like Claude Code/Codex CLI_
  - [x] 16.5.2 Simplify markdown rendering
    - Rewrote `src/markdown.ts` with Shiki syntax highlighting
    - Uses `@shikijs/cli` codeToANSI for VS Code-quality highlighting
    - Added async `renderMarkdownAsync` for full Shiki highlighting
    - Supports github-dark theme with proper ANSI colors
    - _Result: Beautiful syntax highlighting like opencode CLI_
  - [x] 16.5.3 Reduce package dependencies
    - Removed `marked` (17.0.1) dependency
    - Removed `marked-terminal` (7.3.0) dependency
    - Added `@shikijs/cli` for terminal ANSI output
    - _Result: Better highlighting with fewer dependencies_

- [ ] 17. Final cleanup and verification
  - [ ] 17.1 Remove `any` types
    - Search for remaining `any` types
    - Replace with specific type definitions
    - _Requirements: 6.4_
  - [ ] 17.2 Add missing JSDoc comments
    - Add JSDoc to any undocumented public functions
    - _Requirements: 6.3, 7.4_
  - [x] 17.3 Verify line counts
    - App.tsx reduced to 712 lines (from 2409, 70% reduction)
    - ChatFeed.tsx is ~80 lines (well under 200)
    - _Requirements: 1.5, 3.4, 5.2_
    - **Note**: 712 lines is acceptable given complex command/modal logic

- [ ] 18. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- All tests are required for comprehensive coverage
